The RPG program `BB001.rpg36.txt` is an order entry batch selection program for an IBM System/38 or AS/400 (iSeries) system, called from the `BB101.ocl36.txt` OCL program. It manages the selection, creation, updating, and deletion of batch records for order entry processing. Below, I will explain the process steps, business rules, tables (files) used, and external programs called, based on the provided RPG source and its annotations.

### Process Steps of the RPG Program

The program is structured around three display screens (`BB001S1`, `BB001S2`, `BB001S3`) and subroutines to handle batch selection, creation, updating, and deletion. The process steps are as follows:

1. **Initialization (ONETIM Subroutine)**:
   - Clears variables (`CANCEL`, `BLIM`, `Z2`, `Z7`, `Z8`) to reset the environment.
   - Sets the lower limit (`BLIM`) for the `BBBTCH` file to position the file pointer for reading.
   - Calls the `DRLFWD` subroutine to load the first batch record.
   - Checks the program mode (`PGM`): if `PGM='O'` (Order Entry), indicator 44 is turned off; otherwise, it is turned on to restrict certain actions.
   - Initializes the screen for batch selection.

2. **Screen 1: Batch Selection (S1 Subroutine)**:
   - Displays the batch selection screen (`BB001S1`), showing batch numbers, lock status, workstation ID, print status, user, creation date, last update date, and record count.
   - Accepts user input for a batch number (`BTCH#X`) and a delete flag (`DEL`).
   - If the user presses the KG key (cancel), it sets `CANCEL='CANCEL'`, turns on the Last Record (`LR`) indicator, and exits.
   - For a new batch (`BTCH#X=0`):
     - Checks if `PGM='O'`; if not, displays error message COM,2 ("CANNOT CREATE A BATCH NOW") and exits.
     - Retrieves the next batch number (`ABNXTB`) from `BBBTCHX`, increments it, and updates the file (`UPDNXB` exception).
     - Initializes fields: lock status (`LKDESC='AVAILABLE'`), print status (`PRTD='N'`), creation date (`DATE`), and record count (`#REC=0`).
     - Adds the new batch record (`ADDBCH` exception) with `PAR13C` (batch source, per JB01).
   - For an existing batch (`BTCH#X≠0`):
     - Chains to `BBBTCHX` to retrieve the batch record.
     - Validates the batch: if deleted (`ABDEL='D'`) or batch number is 99, displays error message COM,1 ("INVALID BATCH NO. -- PLEASE REKEY").
     - Checks batch source compatibility (`PAR13C` vs. `ABSRCE`); if mismatched, displays error COM,1.
     - Checks lock status (`ABLOCK`):
       - If locked (`ABLOCK≠*BLANK`) and not owned by the current user (`ABUSER≠USER`), displays error COM,3 ("BATCH # IN USE--PLEASE CHOOSE ANOTHER") and releases the batch (`RELBCH`).
       - If locked but owned by the user, proceeds (MG01).
     - Updates batch fields (e.g., last update date, lock status) and displays the confirmation screen (`S2`).

3. **Screen 2: Batch Confirmation (S2 Subroutine)**:
   - Displays the batch confirmation screen (`BB001S2`) with fields like batch number (`BATCH#`), lock description (`LKDESC`), workstation ID (`WSID`), print status (`PRTD`), user (`USER`), creation date (`DTMDY`), last update date (`LUMDY`), and record count (`#REC`).
   - Handles user actions:
     - KA key: Resets the file pointer (`SETLL BBBTCH`), calls `DRLFWD`, and redisplays the screen.
     - If delete is confirmed (`DEL='D'`), displays message COM,4 ("CMD 4 - TO DELETE EXISTING BATCH"), updates the batch record (`UPDBCH`), and sets `LR` if in posting mode (`PGM='P'`).
     - For new batch records, checks if the batch exists (`CHAIN BBBTCHX`); if not, adds it (`ADDBCH`) and sets `LR`.
   - Updates the batch record with current values (`UPDBCH`).

4. **Screen 3: Batch Reset (S3 Subroutine)**:
   - Displays the batch reset screen (`BB001S3`) to confirm batch operations.
   - If the KG key is pressed, chains to `BBBTCHX` for the selected batch, saves the lock status (`SAVBCH`), clears indicators, sets `CANCEL='CANCEL'`, and sets `LR` to exit.
   - Used to reset or cancel batch processing.

5. **Detail Roll Forward (DRLFWD Subroutine)**:
   - Reads the next batch record from `BBBTCH` starting at the lower limit (`BLIM`).
   - Skips records with batch number 99 or delete code `ABDEL='D'`.
   - Checks batch source compatibility (`ABSRCE` vs. `PAR13C`); skips if mismatched (per 10/20/17 update).
   - Maps lock status (`ABLOCK`) to descriptive messages:
     - Blank: COM,11 ("AVAILABLE")
     - 'O': COM,12 ("ORD ENTRY")
     - 'L': COM,13 ("PICK LIST")
     - 'B': COM,15 ("BOL PRINT")
     - 'P': COM,14 ("POSTING")
   - Populates array fields (`BTC`, `LKD`, `LKW`, `PRT`, `USR`, `DTE`, `LUD`, `#RC`) for display.
   - Continues reading until 10 records are loaded or the end of the file is reached.

6. **Detail Roll Backward (DRLBAK Subroutine)**:
   - Sets indicator 21 to indicate no backward roll is implemented (placeholder logic).
   - Minimal functionality, as backward scrolling is not fully supported.

7. **Detail Clear (DETCLR Subroutine)**:
   - Clears array fields (`BTC`, `LKD`, `LKW`, `PRT`, `USR`, `DTE`, `LUD`, `#RC`) to prepare for loading new batch records.

8. **Output Exceptions**:
   - `UPDNXB`: Updates the next batch number in `BBBTCHX`.
   - `ADDBCH`: Adds a new batch record to `BBBTCHX` with fields like `BATCH#`, `PGM`, `WSID`, `PRTD`, `USER`, `DATE`, `LUDT`,ESET

### Business Rules

The program enforces the following business rules:

- **Batch Creation**:
  - New batches can only be created in Order Entry mode (`PGM='O'`); otherwise, error COM,2 is displayed.
  - Batch numbers are incremented from `ABNXTB`, resetting to 1 if reaching 99.
  - New batch records include the batch source (`PAR13C`, added per JB01, 10/12/09).
  - Duplicate batch numbers are prevented; if a batch exists, error COM,3 is shown.

- **Batch Selection**:
  - Batch numbers must be valid (not 99 or deleted, `ABDEL≠'D'`); invalid batches trigger error COM,1.
  - Batches must match the program’s batch source (`PAR13C` vs. `ABSRCE`); mismatches trigger error COM,1 (added 10/27/09).
  - Locked batches (`ABLOCK≠*BLANK`) can only be accessed by the locking user (`ABUSER=USER`, per MG01); otherwise, error COM,3 is shown, and the batch is released.

- **Batch Deletion**:
  - Deletion requires confirmation via the delete flag (`DEL='D'`) and displays message COM,4.
  - Deletion updates the batch record with `DEL='D'` (`DELBCH` exception).

- **Batch Updating**:
  - Updates include the last update date (`LUDT`), lock status, and record count.
  - In posting mode (`PGM='P'`), updates may trigger specific screen transitions.

- **Navigation and Display**:
  - The KG key cancels the operation and exits with `CANCEL='CANCEL'`.
  - The KA key resets the batch list and redisplays the selection screen.
  - Roll keys (status codes 01122 for forward, 01123 for backward) control batch list navigation, though backward rolling is limited.

### Tables (Files) Used

The program uses the following files:
1. `BBBTCH`: Batch master file (input, disk, 48 bytes, logical file with 2 access paths).
2. `BBBTCHX`: Batch master file (update/create, disk, 48 bytes, logical file with 2 access paths).

### External Programs Called

No external programs are explicitly called in `BB001.rpg36.txt`. All processing is handled internally through subroutines and file operations.

### Summary

The `BB001.rpg36.txt` program manages batch selection and maintenance for order entry, providing screens to select, create, update, or delete batch records. It enforces strict validation to ensure batch integrity, such as preventing duplicate or locked batches, restricting creation to Order Entry mode, and ensuring batch source compatibility. The program uses two files (`BBBTCH`, `BBBTCHX`) to store and manage batch data, with no external program calls. Its focus is on maintaining batch records efficiently, supporting the order entry process initiated by the `BB101.ocl36.txt` OCL program.